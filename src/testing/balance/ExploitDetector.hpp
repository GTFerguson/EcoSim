/**
 * @file ExploitDetector.hpp
 * @brief Balance exploit detection module
 *
 * Detects energy flow exploits like baby cannibalism, corpse value
 * imbalances, and other balance-breaking mechanics.
 */

#pragma once

#include "BalanceFramework.hpp"
#include "AnalysisModule.hpp"
#include "ArchetypeProfiler.hpp"
#include "BalanceOptimizer.hpp"
#include "genetics/core/GeneRegistry.hpp"
#include <memory>
#include <vector>
#include <string>

namespace EcoSim {
namespace Balance {

// ExploitSeverity enum and severityToString are defined in BalanceFramework.hpp

/**
 * @brief Analysis module for detecting balance exploits
 *
 * Implements detection rules for known exploit patterns using EXISTING game parameters only:
 * - Rule 1: Baby cannibalism (breeding ROI > 1.0 for carnivores/omnivores)
 * - Rule 2: Corpse value imbalance (corpse worth > lifetime consumption)
 *
 * Recommendations focus on tuning Creature::BREED_COST and Corpse::NUTRITION_PER_SIZE.
 */
class ExploitDetector : public AnalysisModule {
public:
    /**
     * @brief Construct with required dependencies
     * @param registry Shared gene registry
     * @param profiler Archetype profiler (must be run first)
     */
    ExploitDetector(std::shared_ptr<Genetics::GeneRegistry> registry,
                    const ArchetypeProfiler* profiler);
    
    /**
     * @brief Run exploit detection
     * @return true if analysis completed successfully
     */
    bool analyze() override;
    
    /**
     * @brief Get module name
     */
    std::string getName() const override { return "ExploitDetector"; }
    
    /**
     * @brief Get formatted results text
     */
    std::string getResultsText() const override;
    
    /**
     * @brief Contribute results to the balance report
     */
    void contributeToReport(BalanceReport& report) const override;
    
    // --- Accessors ---
    
    /**
     * @brief Get all detected exploits
     */
    const std::vector<ExploitReport>& getExploits() const { return exploits_; }
    
    /**
     * @brief Get highest severity found
     */
    ExploitSeverity getMaxSeverity() const { return maxSeverity_; }
    
    /**
     * @brief Get number of critical exploits
     */
    int getCriticalCount() const;
    
    /**
     * @brief Check if any exploits were detected
     */
    bool hasExploits() const { return !exploits_.empty(); }
    
    /**
     * @brief Get structured recommendations with formula derivations
     */
    const std::vector<BalanceRecommendation>& getRecommendations() const { return recommendations_; }
    
    /**
     * @brief Get LP optimization results
     */
    const OptimizationResult& getOptimizationResult() const { return optimizationResult_; }

private:
    std::shared_ptr<Genetics::GeneRegistry> registry_;
    const ArchetypeProfiler* profiler_;
    std::vector<ExploitReport> exploits_;
    std::vector<BalanceRecommendation> recommendations_;
    ExploitSeverity maxSeverity_ = ExploitSeverity::INFO;
    bool hasRun_ = false;
    
    // LP Optimization
    BalanceOptimizer optimizer_;
    OptimizationResult optimizationResult_;
    
    /**
     * @brief Rule 1: Detect baby cannibalism exploit
     * 
     * Breeding cost << offspring corpse value allows infinite energy.
     */
    void detectBabyCannibalism();
    
    /**
     * @brief Rule 2: Detect corpse value imbalance
     * 
     * If corpse value exceeds lifetime energy consumption, creatures
     * become "energy batteries" that generate net energy when killed.
     */
    void detectCorpseValueImbalance();
    
    /**
     * @brief Add an exploit to the list with its recommendations
     */
    void addExploit(const std::string& name,
                    ExploitSeverity severity,
                    const std::string& description,
                    const std::vector<BalanceRecommendation>& recommendations,
                    const std::vector<std::string>& affectedArchetypes = {});
    
    /**
     * @brief Update max severity if needed
     */
    void updateMaxSeverity(ExploitSeverity s);
};

} // namespace Balance
} // namespace EcoSim
